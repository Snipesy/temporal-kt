# Module core-bridge

This is the module that provides FFM bindings to the Temporal Core Rust library. It also generates the kotlin protobuf
definitions used by the SDK-Core Rust library.

Most (if not all) interop is done against
[temporal-sdk-core-c-bridge.h](./rust/sdk-core/crates/sdk-core-c-bridge/include/temporal-sdk-core-c-bridge.h) found in
the Temporal [SDK-Core submodule](./rust/sdk-core/).

The SDK-Core submodule is included as a workspace member in our [parent Rust workspace](./rust). This workspace wraps the
sdk-core crates and maintains its own `Cargo.lock` for reproducible builds (the sdk-core submodule gitignores its lock file
since it's a library). The C-compatible shared library is built as part of the Gradle build for this module.

## Build (Your Platform)

```bash
gradle build
```

## Build (All Platforms)

```bash
gradle cargoBuildAll
gradle copyAllNativeLibs
gradle build
```

## Updating Dependencies

### Cargo.lock (Rust dependency version bumps)

The `Cargo.lock` at `core-bridge/rust/Cargo.lock` is maintained by our parent workspace (not the sdk-core submodule).
This is intentional - sdk-core gitignores its lock file since it's a library, but we need locked dependencies for
reproducible CI builds. The Gradle build uses `--locked` to enforce this.

To update all Rust dependencies to their latest compatible versions:

```bash
cargo update --manifest-path core-bridge/rust/Cargo.toml
```

To update a specific dependency:

```bash
cargo update --manifest-path core-bridge/rust/Cargo.toml -p <package-name>
```

After updating, commit the updated `Cargo.lock`:

```bash
git add core-bridge/rust/Cargo.lock
git commit -m "Update Rust dependencies"
```

### SDK-Core Submodule (upstream changes)

The SDK-Core submodule (`core-bridge/rust/sdk-core`) is a fork/clone of [temporalio/sdk-core](https://github.com/temporalio/sdk-core).

**Important:** Our parent workspace (`core-bridge/rust/Cargo.toml`) mirrors the `[workspace.dependencies]` from
sdk-core's Cargo.toml. When updating sdk-core, check if its workspace dependencies changed and sync them if needed.

To update to the latest upstream master:

```bash
git submodule update --remote core-bridge/rust/sdk-core
# Check if workspace.dependencies changed in sdk-core/Cargo.toml and sync to rust/Cargo.toml if needed
cargo update --manifest-path core-bridge/rust/Cargo.toml
git add core-bridge/rust/sdk-core core-bridge/rust/Cargo.lock core-bridge/rust/Cargo.toml
git commit -m "Update sdk-core to <commit-sha>"
```

To update to a specific commit or tag:

```bash
cd core-bridge/rust/sdk-core
git fetch origin
git checkout <commit-sha-or-tag>
cd ../../..
# Check if workspace.dependencies changed in sdk-core/Cargo.toml and sync to rust/Cargo.toml if needed
cargo update --manifest-path core-bridge/rust/Cargo.toml
git add core-bridge/rust/sdk-core core-bridge/rust/Cargo.lock core-bridge/rust/Cargo.toml
git commit -m "Update sdk-core to <version>"
```

## Regenerating Bindings

### Kotlin Protobuf Classes (automatic)

Kotlin protobuf classes are auto-generated by Gradle from protos in the sdk-core submodule:
- `crates/common/protos/api_upstream` - Temporal API protos (from [temporalio/api](https://github.com/temporalio/api))
- `crates/common/protos/testsrv_upstream` - Test server protos (from sdk-java)
- `crates/common/protos/local` - Local protos

**No manual regeneration needed** - protos are regenerated automatically during `gradle build`.

### Java FFM Bindings (manual - JExtract)

JExtract generates Java FFM bindings from the C header. Regeneration is required when the C header changes (typically after sdk-core updates).

See the existing "JExtract" section below for regeneration commands.

## JExtract 

JExtract is used to generate Java bindings for the native libraries.
https://jdk.java.net/jextract/

Regeneration is currently a manual process. To regenerate the bindings, run the following command from the root of the repository:

```bash
jextract @includes.txt --output ./src/main/java --target-package io.temporal.sdkbridge ./rust/sdk-core/crates/sdk-core-c-bridge/include/temporal-sdk-core-c-bridge.h
```

To regenerate a new includes do

```bash
jextract --dump-includes includes.txt ./rust/sdk-core/crates/sdk-core-c-bridge/include/temporal-sdk-core-c-bridge.h
```

Then remove any non-portable files. (i.e. MAC OS / Darwin specific things) which are not important for the bindings.
Commit the results without modification.

Note that in rust many structs are opaque and will generate errors (thats fine)

```
temporal-sdk-core-c-bridge.h:68:16: warning: Skipping TemporalCoreClientGrpcOverrideRequest (type Declared(TemporalCoreClientGrpcOverrideRequest) is not supported)
```
