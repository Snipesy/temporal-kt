name: Publish to Maven Central

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use gradle.properties version)'
        required: false
        type: string

# Cancel in-progress runs for the same branch (but not for releases)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  # ===== NATIVE BUILD JOBS (matrix) =====

  build-native:
    name: Build Native (${{ matrix.platform }})
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64-gnu
            rust-targets: x86_64-unknown-linux-gnu
            gradle-task: copyNativeLibLinuxx8664
            artifact-name: native-libs-linux-x86_64-gnu
            artifact-path: core-bridge/build/native-libs/native/linux-x86_64-gnu
          - os: ubuntu-24.04-arm
            platform: linux-aarch64-gnu
            rust-targets: aarch64-unknown-linux-gnu
            gradle-task: copyNativeLibLinuxAarch64
            artifact-name: native-libs-linux-aarch64-gnu
            artifact-path: core-bridge/build/native-libs/native/linux-aarch64-gnu
          - os: macos-14
            platform: macos-aarch64
            rust-targets: aarch64-apple-darwin
            gradle-task: copyMacosAarch64NativeLib
            artifact-name: native-libs-macos-aarch64
            artifact-path: core-bridge/build/native-libs/native/macos-aarch64
          - os: macos-15-intel
            platform: macos-x86_64
            rust-targets: x86_64-apple-darwin
            gradle-task: copyMacosx8664NativeLib
            artifact-name: native-libs-macos-x86_64
            artifact-path: core-bridge/build/native-libs/native/macos-x86_64
          - os: windows-latest
            platform: windows
            rust-targets: x86_64-pc-windows-msvc
            gradle-task: copyWindowsNativeLib
            artifact-name: native-libs-windows
            artifact-path: core-bridge/build/native-libs/native/windows-x86_64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.rust-targets }}
          cache-workspaces: "core-bridge/rust -> target"
          cache-all-crates: true
          cache-on-failure: true

      - name: Install protobuf (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protobuf (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build native library
        run: ./gradlew :core-bridge:${{ matrix.gradle-task }} --no-daemon

      - name: Upload native lib
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}
          retention-days: 1

  # ===== PLATFORM TEST JOBS (matrix, after native builds) =====

  test:
    name: Test (${{ matrix.platform }})
    needs: [build-native]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64-gnu
            artifact-name: native-libs-linux-x86_64-gnu
            artifact-path: core-bridge/build/native-libs/native/linux-x86_64-gnu
          - os: ubuntu-24.04-arm
            platform: linux-aarch64-gnu
            artifact-name: native-libs-linux-aarch64-gnu
            artifact-path: core-bridge/build/native-libs/native/linux-aarch64-gnu
          - os: macos-14
            platform: macos-aarch64
            artifact-name: native-libs-macos-aarch64
            artifact-path: core-bridge/build/native-libs/native/macos-aarch64
          - os: macos-15-intel
            platform: macos-x86_64
            artifact-name: native-libs-macos-x86_64
            artifact-path: core-bridge/build/native-libs/native/macos-x86_64
          - os: windows-latest
            platform: windows
            artifact-name: native-libs-windows
            artifact-path: core-bridge/build/native-libs/native/windows-x86_64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Install protobuf (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protobuf (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download native lib
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}

      - name: Build and test
        run: ./gradlew build -PskipNativeBuild=true --no-daemon

  # ===== PUBLISH JOB (runs after all builds and tests) =====

  publish:
    name: Publish to Maven Central
    needs: [build-native, test]
    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for release asset uploads
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Install protobuf
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Download all native lib artifacts into the expected directory structure
      - name: Download Linux x86_64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-linux-x86_64-gnu
          path: core-bridge/build/native-libs/native/linux-x86_64-gnu

      - name: Download Linux aarch64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-linux-aarch64-gnu
          path: core-bridge/build/native-libs/native/linux-aarch64-gnu

      - name: Download macOS ARM64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-macos-aarch64
          path: core-bridge/build/native-libs/native/macos-aarch64

      - name: Download macOS x86_64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-macos-x86_64
          path: core-bridge/build/native-libs/native/macos-x86_64

      - name: Download Windows native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-windows
          path: core-bridge/build/native-libs/native/windows-x86_64

      - name: Verify native libraries
        run: |
          echo "Native libraries downloaded:"
          find core-bridge/build/native-libs -type f -name "*.so" -o -name "*.dylib" -o -name "*.dll" | sort
          echo ""
          echo "Expected structure:"
          echo "  native/linux-x86_64-gnu/libtemporalio_sdk_core_c_bridge.so"
          echo "  native/linux-aarch64-gnu/libtemporalio_sdk_core_c_bridge.so"
          echo "  native/macos-x86_64/libtemporalio_sdk_core_c_bridge.dylib"
          echo "  native/macos-aarch64/libtemporalio_sdk_core_c_bridge.dylib"
          echo "  native/windows-x86_64/temporalio_sdk_core_c_bridge.dll"

      - name: Set version from release tag
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "Publishing version: $VERSION"
          sed -i "s/version=.*/version=$VERSION/" gradle.properties

      - name: Set version from input
        if: github.event_name == 'workflow_dispatch' && inputs.version != ''
        run: |
          echo "Publishing version: ${{ inputs.version }}"
          sed -i "s/version=.*/version=${{ inputs.version }}/" gradle.properties

      - name: Build classifier JARs
        run: |
          ./gradlew :core-bridge:jar \
            :core-bridge:linuxx8664gnuNativeJar \
            :core-bridge:linuxaarch64gnuNativeJar \
            :core-bridge:macosx8664NativeJar \
            :core-bridge:macosaarch64NativeJar \
            :core-bridge:windowsx8664NativeJar \
            -PskipNativeBuild=true --no-daemon

      - name: Verify JAR contents
        run: |
          echo "=== Main JAR (should have no natives) ==="
          MAIN_JAR=$(ls core-bridge/build/libs/core-bridge-*.jar | grep -v '\-linux\|\-macos\|\-windows' | head -1)
          echo "Checking: $MAIN_JAR"
          if jar tf "$MAIN_JAR" | grep -q "^native/"; then
            echo "ERROR: Main JAR contains native libraries!"
            jar tf "$MAIN_JAR" | grep "^native/"
            exit 1
          else
            echo "OK - No native libraries in main JAR"
          fi
          echo ""
          echo "=== Classifier JARs ==="
          for f in core-bridge/build/libs/core-bridge-*-linux-*.jar core-bridge/build/libs/core-bridge-*-macos-*.jar core-bridge/build/libs/core-bridge-*-windows-*.jar; do
            if [ -f "$f" ]; then
              echo "--- $f ---"
              jar tf "$f" | head -5
            fi
          done

      - name: Publish to Maven Central
        run: |
          ./gradlew publishToMavenCentral \
            -PskipNativeBuild=true \
            -PsigningInMemoryKey="${{ secrets.SIGNING_KEY }}" \
            -PsigningInMemoryKeyPassword="${{ secrets.SIGNING_PASSWORD }}" \
            -PmavenCentralUsername="${{ secrets.OSSRH_USERNAME }}" \
            -PmavenCentralPassword="${{ secrets.OSSRH_TOKEN }}" \
            --no-configuration-cache --no-daemon

      - name: Build JARs for release assets
        if: github.event_name == 'release'
        run: |
          ./gradlew jar \
            :core-bridge:linuxx8664gnuNativeJar \
            :core-bridge:linuxaarch64gnuNativeJar \
            :core-bridge:macosx8664NativeJar \
            :core-bridge:macosaarch64NativeJar \
            :core-bridge:windowsx8664NativeJar \
            -PskipNativeBuild=true --no-configuration-cache --no-daemon

      - name: Upload artifacts to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            core-bridge/build/libs/*.jar
            core/build/libs/*.jar
            core-testing/build/libs/*.jar
            compiler-plugin/build/libs/*.jar
            gradle-plugin/build/libs/*.jar
            plugins/di/build/libs/*.jar
            plugins/opentelemetry/build/libs/*.jar
