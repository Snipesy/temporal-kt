name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use gradle.properties version)'
        required: false
        type: string

jobs:
  publish:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: |
            x86_64-unknown-linux-gnu
            aarch64-unknown-linux-gnu
            x86_64-pc-windows-gnu
            aarch64-apple-darwin

      - name: Install cross-compilation dependencies
        run: |
          brew install zig mingw-w64 protobuf
          cargo install cargo-zigbuild

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set version from release tag
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "Publishing version: $VERSION"
          sed -i '' "s/version=.*/version=$VERSION/" gradle.properties

      - name: Set version from input
        if: github.event_name == 'workflow_dispatch' && inputs.version != ''
        run: |
          echo "Publishing version: ${{ inputs.version }}"
          sed -i '' "s/version=.*/version=${{ inputs.version }}/" gradle.properties

      - name: Build native libraries and publish to Maven Central
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          gradle copyAllNativeLibs publishAllPublicationsToMavenCentralRepository --no-daemon

      - name: Close and Release Staging Repository
        if: "!contains(github.event.release.tag_name, '-')"
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          echo "Note: Manual release from Nexus Repository Manager may be required"
          echo "Visit https://s01.oss.sonatype.org to close and release the staging repository"