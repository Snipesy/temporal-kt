name: Publish to Maven Central

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use gradle.properties version)'
        required: false
        type: string

# Cancel in-progress runs for the same branch (but not for releases)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  # ===== NATIVE BUILD JOBS (matrix) =====

  build-native:
    name: Build Native (${{ matrix.platform }})
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            rust-targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu
            gradle-task: copyLinuxNativeLibs
            artifact-name: native-libs-linux
            artifact-path: core-bridge/build/native-libs/native/linux-*
            needs-zig: true
          - os: macos-14
            platform: darwin-aarch64
            rust-targets: aarch64-apple-darwin
            gradle-task: copyDarwinAarch64NativeLib
            artifact-name: native-libs-darwin-aarch64
            artifact-path: core-bridge/build/native-libs/native/darwin-aarch64
            needs-zig: false
          - os: macos-15-intel
            platform: darwin-x86_64
            rust-targets: x86_64-apple-darwin
            gradle-task: copyDarwinx8664NativeLib
            artifact-name: native-libs-darwin-x86_64
            artifact-path: core-bridge/build/native-libs/native/darwin-x86_64
            needs-zig: false
          - os: windows-latest
            platform: windows
            rust-targets: x86_64-pc-windows-msvc
            gradle-task: copyWindowsNativeLib
            artifact-name: native-libs-windows
            artifact-path: core-bridge/build/native-libs/native/windows-*
            needs-zig: false

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.rust-targets }}

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "core-bridge/rust -> target"
          key: ${{ matrix.platform }}
          cache-workspace-crates: "true"

      - name: Set up Zig
        if: matrix.needs-zig
        uses: mlugg/setup-zig@v2

      - name: Install cargo-zigbuild and protobuf (Linux)
        if: runner.os == 'Linux'
        run: |
          cargo install cargo-zigbuild
          sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protobuf (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build native library
        run: ./gradlew :core-bridge:${{ matrix.gradle-task }} --no-daemon

      - name: Upload native lib
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}
          retention-days: 1

  # ===== PLATFORM TEST JOBS (matrix, after native builds) =====

  test:
    name: Test (${{ matrix.platform }})
    needs: [build-native]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64
            artifact-name: native-libs-linux
            artifact-path: core-bridge/build/native-libs/native/
          - os: ubuntu-24.04-arm
            platform: linux-aarch64
            artifact-name: native-libs-linux
            artifact-path: core-bridge/build/native-libs/native/
          - os: macos-14
            platform: darwin-aarch64
            artifact-name: native-libs-darwin-aarch64
            artifact-path: core-bridge/build/native-libs/native/darwin-aarch64
          - os: macos-15-intel
            platform: darwin-x86_64
            artifact-name: native-libs-darwin-x86_64
            artifact-path: core-bridge/build/native-libs/native/darwin-x86_64
          - os: windows-latest
            platform: windows
            artifact-name: native-libs-windows
            artifact-path: core-bridge/build/native-libs/native/

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Install protobuf (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protobuf (Windows)
        if: runner.os == 'Windows'
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download native lib
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}

      - name: Build and test
        run: ./gradlew build -PskipNativeBuild=true --no-daemon

  # ===== PUBLISH JOB (runs after all builds and tests) =====

  publish:
    name: Publish to Maven Central
    needs: [build-native, test]
    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for release asset uploads
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'

      - name: Install protobuf
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Download all native lib artifacts into the expected directory structure
      - name: Download Linux native libs
        uses: actions/download-artifact@v4
        with:
          name: native-libs-linux
          path: core-bridge/build/native-libs/native/

      - name: Download Darwin ARM64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-darwin-aarch64
          path: core-bridge/build/native-libs/native/darwin-aarch64

      - name: Download Darwin x86_64 native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-darwin-x86_64
          path: core-bridge/build/native-libs/native/darwin-x86_64

      - name: Download Windows native lib
        uses: actions/download-artifact@v4
        with:
          name: native-libs-windows
          path: core-bridge/build/native-libs/native/

      - name: Verify native libraries
        run: |
          echo "Native libraries downloaded:"
          find core-bridge/build/native-libs -type f -name "*.so" -o -name "*.dylib" -o -name "*.dll" | sort
          echo ""
          echo "Expected structure:"
          echo "  native/linux-x86_64/libtemporalio_sdk_core_c_bridge.so"
          echo "  native/linux-aarch64/libtemporalio_sdk_core_c_bridge.so"
          echo "  native/darwin-x86_64/libtemporalio_sdk_core_c_bridge.dylib"
          echo "  native/darwin-aarch64/libtemporalio_sdk_core_c_bridge.dylib"
          echo "  native/windows-x86_64/temporalio_sdk_core_c_bridge.dll"

      - name: Set version from release tag
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "Publishing version: $VERSION"
          sed -i "s/version=.*/version=$VERSION/" gradle.properties

      - name: Set version from input
        if: github.event_name == 'workflow_dispatch' && inputs.version != ''
        run: |
          echo "Publishing version: ${{ inputs.version }}"
          sed -i "s/version=.*/version=${{ inputs.version }}/" gradle.properties

      - name: Publish to Maven Central
        run: |
          ./gradlew publishToMavenCentral \
            -PskipNativeBuild=true \
            -PsigningInMemoryKey="${{ secrets.SIGNING_KEY }}" \
            -PsigningInMemoryKeyPassword="${{ secrets.SIGNING_PASSWORD }}" \
            -PmavenCentralUsername="${{ secrets.OSSRH_USERNAME }}" \
            -PmavenCentralPassword="${{ secrets.OSSRH_TOKEN }}" \
            --no-configuration-cache --no-daemon

      - name: Build JARs for release assets
        if: github.event_name == 'release'
        run: |
          ./gradlew jar \
            -PskipNativeBuild=true --no-configuration-cache --no-daemon

      - name: Upload artifacts to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            core-bridge/build/libs/*.jar
            core/build/libs/*.jar
            core-testing/build/libs/*.jar
            compiler-plugin/build/libs/*.jar
            gradle-plugin/build/libs/*.jar
            plugins/di/build/libs/*.jar
            plugins/opentelemetry/build/libs/*.jar
